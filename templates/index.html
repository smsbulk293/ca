<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Simple Bulk SMS (Canada only)</title>
  <style>
    body{font-family:system-ui, Arial; max-width:900px;margin:24px auto;padding:0 12px}
    textarea,input,select{width:100%;padding:8px;margin:6px 0;border:1px solid #ddd;border-radius:6px}
    button{padding:10px 16px;border-radius:8px;border:0;background:#2563eb;color:white;cursor:pointer}
    .row{display:flex;gap:12px}
    .col{flex:1}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #eee;padding:6px;text-align:left}
    .small{font-size:13px;color:#666'}
    .muted{color:#666;font-size:13px}
  </style>
</head>
<body>
  <h1>Bulk SMS — Canada Only</h1>
  <p class="muted">Price per SMS: <strong>$0.023 USD</strong> (charged automatically). Wallet balance is shown in USD. Only Canadian numbers are accepted.</p>

  <label>Upload CSV file (columns: phone,message OR phone,name)</label>
  <input type="file" id="csvFile" accept=".csv">

  <label>Or paste CSV content</label>
  <textarea id="csvText" rows="6" placeholder="phone,name,message"></textarea>

  <label>Or enter a template (use {{name}}). If left blank, per-row message column must exist.</label>
  <textarea id="template" rows="3" placeholder="Hi {{name}}, your code is 1234"></textarea>

  <div style="display:flex;gap:12px;margin-top:8px">
    <button id="estimateBtn">Estimate & Preview</button>
    <button id="sendBtn" style="background:#059669">Reserve & Send</button>
  </div>

  <h3>Preview</h3>
  <div id="preview"></div>

  <h3>Wallet</h3>
  <div id="walletArea">
    <button id="refreshWallet">Refresh</button>
    <div id="walletInfo"></div>
    <div class="small">To top up: call admin endpoint with header <code>X-ADMIN-TOKEN</code>. Amount must be in mills (1 mill = $0.001). Example: top-up 100000 mills = $100.000</div>
  </div>

  <script>
    const PRICE_PER_SMS_USD = 0.023; // display only
    const PRICE_PER_SMS_MILLS = 23; // server-side uses mills

    async function toText(file){
      if(!file) return '';
      return await file.text();
    }

    async function parseCsvServer(csvText, template, defaultCountry, send){
      const res = await fetch('/api/estimate', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ csv: csvText, template, defaultCountry, send })
      });
      return await res.json();
    }

    function renderPreview(rows, totals, rejected){
      const container = document.getElementById('preview');
      if(!rows || rows.length===0){ container.innerHTML = '<div class="small">No rows parsed yet.</div>'; return; }
      let html = `<div class="muted">Rows parsed: ${rows.length} — Estimated segments: ${totals.segments} — Estimated cost: ${totals.cost_usd} USD</div>`;
      if(rejected && rejected.length>0){
        html += `<div style="color:#b91c1c;margin-top:8px"><strong>Rejected rows:</strong> ${rejected.length}. Check CSV and ensure numbers are Canadian (+1 country code or valid Canada format).</div>`;
      }
      html += '<table><thead><tr><th>#</th><th>phone</th><th>message</th><th>segments</th></tr></thead><tbody>';
      for(let i=0;i<Math.min(rows.length,20);i++){
        html += `<tr><td>${i+1}</td><td>${rows[i].phone||''}</td><td>${rows[i].message||''}</td><td>${rows[i].segments||''}</td></tr>`;
      }
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    document.getElementById('estimateBtn').onclick = async () => {
      const fileEl = document.getElementById('csvFile');
      const file = fileEl.files[0];
      let text = document.getElementById('csvText').value;
      if(file && !text) text = await toText(file);
      if(!text){ alert('Provide CSV'); return; }
      const template = document.getElementById('template').value;
      const defaultCountry = 'CA';
      const j = await parseCsvServer(text, template, defaultCountry, false);
      if(j.error) return alert(j.error);
      const totals = { segments: j.totalSegments, cost_usd: j.totalCost_usd };
      renderPreview(j.rows, totals, j.rejected || []);
    };

    document.getElementById('sendBtn').onclick = async () => {
      const fileEl = document.getElementById('csvFile');
      const file = fileEl.files[0];
      let text = document.getElementById('csvText').value;
      if(file && !text) text = await toText(file);
      if(!text){ alert('Provide CSV'); return; }
      const template = document.getElementById('template').value;
      const defaultCountry = 'CA';
      const j = await parseCsvServer(text, template, defaultCountry, true);
      if(j.error) return alert(j.error);
      const totals = { segments: j.totalSegments, cost_usd: j.totalCost_usd };
      renderPreview(j.rows, totals, j.rejected || []);
      alert('Job queued! Job id: ' + j.jobId + '\nEstimated cost: ' + j.totalCost_usd + ' USD');
    };

    async function refreshWallet(){
      const r = await fetch('/api/wallet');
      const j = await r.json();
      document.getElementById('walletInfo').innerHTML = `<div>Balance: <strong>${j.balance_usd} USD</strong> (${j.balance_mills} mills)</div>`;
    }
    document.getElementById('refreshWallet').onclick = refreshWallet;
    refreshWallet();
  </script>
</body>
</html>
