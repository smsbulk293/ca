<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Simple Bulk SMS (Python)</title>
  <style>
    body{font-family:system-ui, Arial; max-width:900px;margin:24px auto;padding:0 12px}
    textarea,input,select{width:100%;padding:8px;margin:6px 0;border:1px solid #ddd;border-radius:6px}
    button{padding:10px 16px;border-radius:8px;border:0;background:#2563eb;color:white;cursor:pointer}
    .row{display:flex;gap:12px}
    .col{flex:1}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #eee;padding:6px;text-align:left}
    .small{font-size:13px;color:#666}
  </style>
</head>
<body>
  <h1>Bulk SMS — Simple (Python)</h1>
  <p class="small">Upload CSV (columns: phone,message OR phone,name & enter template). Phone should include country code or use default country below.</p>

  <label>Default country (for parsing numbers) — e.g. IN, US</label>
  <input id="defaultCountry" value="IN">

  <label>Upload CSV file</label>
  <input type="file" id="csvFile" accept=".csv">

  <label>Or paste CSV content</label>
  <textarea id="csvText" rows="6" placeholder="phone,name,message"></textarea>

  <label>Or enter a template (use {{name}}). If left blank, per-row message column must exist.</label>
  <textarea id="template" rows="3" placeholder="Hi {{name}}, your code is 1234"></textarea>

  <label>Price per SMS segment (in paise/cents) — e.g. 50 = ₹0.50</label>
  <input id="pricePerSegment" value="50">

  <div style="display:flex;gap:12px;margin-top:8px">
    <button id="estimateBtn">Estimate & Preview</button>
    <button id="sendBtn" style="background:#059669">Reserve & Send</button>
  </div>

  <h3>Preview</h3>
  <div id="preview"></div>

  <h3>Wallet</h3>
  <div id="walletArea">
    <button id="refreshWallet">Refresh</button>
    <div id="walletInfo"></div>
    <div class="small">To top up quickly: call admin endpoint with header X-ADMIN-TOKEN or update data/wallet.json for local testing.</div>
  </div>

  <script>
    async function toText(file){
      if(!file) return '';
      return await file.text();
    }

    async function parseCsvServer(csvText, template, pricePerSegment, defaultCountry, send){
      const res = await fetch('/api/estimate', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ csv: csvText, template, pricePerSegment, defaultCountry, send })
      });
      return await res.json();
    }

    function renderPreview(rows, totals){
      const container = document.getElementById('preview');
      if(!rows || rows.length===0){ container.innerHTML = '<div class="small">No rows parsed yet.</div>'; return; }
      let html = `<div class="small">Rows parsed: ${rows.length} — Estimated segments: ${totals.segments} — Estimated cost: ${totals.cost} (in smallest currency unit)</div>`;
      html += '<table><thead><tr><th>#</th><th>phone</th><th>message</th><th>segments</th></tr></thead><tbody>';
      for(let i=0;i<Math.min(rows.length,20);i++){
        html += `<tr><td>${i+1}</td><td>${rows[i].phone||''}</td><td>${rows[i].message||''}</td><td>${rows[i].segments||''}</td></tr>`;
      }
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    document.getElementById('estimateBtn').onclick = async () => {
      const fileEl = document.getElementById('csvFile');
      const file = fileEl.files[0];
      let text = document.getElementById('csvText').value;
      if(file && !text) text = await toText(file);
      if(!text){ alert('Provide CSV'); return; }
      const template = document.getElementById('template').value;
      const pricePerSegment = parseInt(document.getElementById('pricePerSegment').value||'0',10);
      const defaultCountry = document.getElementById('defaultCountry').value||'IN';
      const j = await parseCsvServer(text, template, pricePerSegment, defaultCountry, false);
      if(j.error) return alert(j.error);
      renderPreview(j.rows, {segments:j.totalSegments, cost:j.totalCost});
    };

    document.getElementById('sendBtn').onclick = async () => {
      const fileEl = document.getElementById('csvFile');
      const file = fileEl.files[0];
      let text = document.getElementById('csvText').value;
      if(file && !text) text = await toText(file);
      if(!text){ alert('Provide CSV'); return; }
      const template = document.getElementById('template').value;
      const pricePerSegment = parseInt(document.getElementById('pricePerSegment').value||'0',10);
      const defaultCountry = document.getElementById('defaultCountry').value||'IN';
      const j = await parseCsvServer(text, template, pricePerSegment, defaultCountry, true);
      if(j.error) return alert(j.error);
      renderPreview(j.rows, {segments:j.totalSegments, cost:j.totalCost});
      alert('Job queued! Job id: ' + j.jobId);
    };

    async function refreshWallet(){
      const r = await fetch('/api/wallet');
      const j = await r.json();
      document.getElementById('walletInfo').innerHTML = `<div>Balance: ${j.balance} (smallest currency unit)</div>`;
    }
    document.getElementById('refreshWallet').onclick = refreshWallet;
    refreshWallet();
  </script>
</body>
</html>

